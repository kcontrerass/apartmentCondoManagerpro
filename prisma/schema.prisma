generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// Enums
enum Role {
  SUPER_ADMIN
  ADMIN
  OPERATOR
  GUARD
  RESIDENT
}

enum UserStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
}

enum ComplexType {
  BUILDING    // Edificio Vertical
  RESIDENTIAL // Residencial Horizontal
  CONDO       // Condominio Mixto
}

enum UnitStatus {
  OCCUPIED
  VACANT
  MAINTENANCE
}

enum ResidentType {
  OWNER
  TENANT
}

enum ReservationStatus {
  PENDING
  APPROVED
  CANCELLED
  REJECTED
  COMPLETED
}

enum AmenityType {
  POOL
  GYM
  CLUBHOUSE
  COURT
  BBQ
  OTHER
}

enum VisitorStatus {
  SCHEDULED
  ARRIVED
  DEPARTED
  CANCELLED
}

// Models

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  password      String // Hashed
  name          String
  phone         String?
  image         String?   @db.Text
  role          Role      @default(RESIDENT)
  status        UserStatus @default(ACTIVE)
  
  resetPasswordToken   String?   @unique
  resetPasswordExpires DateTime?
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  residentProfile Resident?
  managedComplexes Complex[] // For ADMIN role
  reservations     Reservation[]
  visitorLogs      VisitorLog[]  @relation("CreatedVisitorLogs")

  // For Staff (GUARDS/OPERATORS)
  complexId        String?       @map("complex_id")
  assignedComplex  Complex?      @relation("StaffComplex", fields: [complexId], references: [id])

  @@map("users")
}

model Complex {
  id          String      @id @default(cuid())
  name        String
  address     String      @db.Text
  type        ComplexType @default(BUILDING)
  logoUrl     String?     @map("logo_url")
  settings    Json?       // Flexible settings (colors, rules, etc)
  
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  
  // Relations
  adminId     String?     @unique
  admin       User?       @relation(fields: [adminId], references: [id])
  units       Unit[]
  amenities   Amenity[]
  services    Service[]
  invoices    Invoice[]
  visitorLogs VisitorLog[]
  staff       User[]      @relation("StaffComplex")

  @@map("complexes")
}

model Unit {
  id          String     @id @default(cuid())
  number      String     // e.g. "101", "A-20"
  type        String?    // e.g. "Apartment", "Penthouse"
  bedrooms    Int        @default(1)
  bathrooms   Float      @default(1.0)
  parkingSpots Int       @default(0) @map("parking_spots")
  area        Float?     // in sq meters
  
  status      UnitStatus @default(VACANT)
  
  complexId   String     @map("complex_id")
  complex     Complex    @relation(fields: [complexId], references: [id], onDelete: Cascade)
  
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
 
  // Relations
  residents   Resident[]
  services    UnitService[]
  invoices    Invoice[]
  visitorLogs VisitorLog[]

  @@unique([complexId, number]) // Unit numbers must be unique within a complex
  @@map("units")
}

model Resident {
  id              String       @id @default(cuid())
  type            ResidentType @default(TENANT)
  
  startDate       DateTime     @map("start_date")
  endDate         DateTime?    @map("end_date")
  
  emergencyContact Json?       @map("emergency_contact") // {name, phone, relation}
  
  userId          String       @unique @map("user_id")
  user            User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  unitId          String       @map("unit_id")
  unit            Unit         @relation(fields: [unitId], references: [id], onDelete: Cascade)
  
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt

  @@map("residents")
}

model Amenity {
  id             String      @id @default(cuid())
  name           String
  description    String?     @db.Text
  type           AmenityType @default(OTHER)
  
  capacity       Int?
  operatingHours Json?       @map("operating_hours") // {open, close, days}
  
  costPerDay     Decimal?    @map("cost_per_day") @db.Decimal(10, 2)
  costPerHour    Decimal?    @map("cost_per_hour") @db.Decimal(10, 2)
  
  complexId      String      @map("complex_id")
  complex        Complex     @relation(fields: [complexId], references: [id], onDelete: Cascade)
  
  createdAt      DateTime    @default(now())
  updatedAt      DateTime    @updatedAt

  reservations   Reservation[]

  @@map("amenities")
}

model Reservation {
  id             String            @id @default(cuid())
  startTime      DateTime          @map("start_date_time")
  endTime        DateTime          @map("end_date_time")
  status         ReservationStatus @default(PENDING)
  notes          String?           @db.Text
  totalCost      Decimal?          @map("total_cost") @db.Decimal(10, 2)

  userId         String            @map("user_id")
  user           User              @relation(fields: [userId], references: [id], onDelete: Cascade)

  amenityId      String            @map("amenity_id")
  amenity        Amenity           @relation(fields: [amenityId], references: [id], onDelete: Cascade)

  createdAt      DateTime          @default(now())
  updatedAt      DateTime          @updatedAt

  @@map("reservations")
}

model Service {
  id             String      @id @default(cuid())
  name           String
  description    String?     @db.Text
  basePrice      Decimal     @map("base_price") @db.Decimal(10, 2)
  frequency      ServiceFrequency @default(MONTHLY)
  isRequired     Boolean     @default(false)
  hasQuantity    Boolean     @default(false)
  
  complexId      String      @map("complex_id")
  complex        Complex     @relation(fields: [complexId], references: [id], onDelete: Cascade)
  
  unitServices   UnitService[]
  
  createdAt      DateTime    @default(now())
  updatedAt      DateTime    @updatedAt

  @@map("services")
}

enum ServiceFrequency {
  ONCE
  DAILY
  WEEKLY
  MONTHLY
  YEARLY
}

model UnitService {
  id             String      @id @default(cuid())
  
  // Custom price for this unit, if null use service basePrice
  customPrice    Decimal?    @map("custom_price") @db.Decimal(10, 2)
  quantity       Int         @default(1)
  
  status         UnitServiceStatus @default(ACTIVE)
  
  serviceId      String      @map("service_id")
  service        Service     @relation(fields: [serviceId], references: [id], onDelete: Cascade)
  
  unitId         String      @map("unit_id")
  unit           Unit        @relation(fields: [unitId], references: [id], onDelete: Cascade)
  
  startDate      DateTime    @default(now()) @map("start_date")
  endDate        DateTime?   @map("end_date")
  
  createdAt      DateTime    @default(now())
  updatedAt      DateTime    @updatedAt

  @@unique([unitId, serviceId])
  @@map("unit_services")
}

enum UnitServiceStatus {
  ACTIVE
  INACTIVE
}

model Invoice {
  id             String        @id @default(cuid())
  number         String        @unique // Correlative number e.g. INV-001
  
  month          Int
  year           Int
  dueDate        DateTime      @map("due_date")
  
  totalAmount    Decimal       @map("total_amount") @db.Decimal(10, 2)
  status         InvoiceStatus @default(PENDING)
  
  unitId         String        @map("unit_id")
  unit           Unit          @relation(fields: [unitId], references: [id], onDelete: Cascade)
  
  complexId      String        @map("complex_id")
  complex        Complex       @relation(fields: [complexId], references: [id], onDelete: Cascade)
  
  items          InvoiceItem[]
  
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt

  @@map("invoices")
}

model InvoiceItem {
  id             String   @id @default(cuid())
  invoiceId      String   @map("invoice_id")
  invoice        Invoice  @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  
  description    String
  amount         Decimal  @db.Decimal(10, 2)
  
  serviceId      String?  @map("service_id")
  
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@map("invoice_items")
}

enum InvoiceStatus {
  PENDING
  PAID
  OVERDUE
  CANCELLED
}

model VisitorLog {
  id            String        @id @default(cuid())
  visitorName   String        @map("visitor_name")
  visitorId     String?       @map("visitor_id_card") // Documento de identidad
  reason        String?       @db.Text
  
  status        VisitorStatus @default(SCHEDULED)
  
  entryTime     DateTime?     @map("entry_time")
  exitTime      DateTime?     @map("exit_time")
  scheduledDate DateTime      @map("scheduled_date")

  // Relations
  unitId        String        @map("unit_id")
  unit          Unit          @relation(fields: [unitId], references: [id], onDelete: Cascade)
  
  complexId     String        @map("complex_id")
  complex       Complex       @relation(fields: [complexId], references: [id], onDelete: Cascade)
  
  createdById   String        @map("created_by_id")
  createdBy     User          @relation("CreatedVisitorLogs", fields: [createdById], references: [id])

  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  @@map("visitor_logs")
}
